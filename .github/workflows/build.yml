name: Build WRT

on:
  workflow_dispatch:
    inputs:
      project:
        description: "é€‰æ‹© WRT é¡¹ç›®"
        required: true
        default: "immortalwrt"
        type: choice
        options:
          - openwrt
          - immortalwrt
          - immortalwrt-mt798x
          - immortalwrt-mt798x-6.6
      tag:
        description: "ç‰ˆæœ¬å·"
        required: false
        default: "v24.10.3"
        type: string
      version_type:
        description: "ç‰ˆæœ¬ç±»å‹"
        required: true
        default: "stable"
        type: choice
        options:
          - "snapshot"
          - "stable"
      config_path:
        description: "é…ç½®æ–‡ä»¶è·¯å¾„ï¼ˆç•™ç©ºåˆ™è·³è¿‡ï¼‰"
        required: false
        default: "config/x86_64_config"
        type: string
      proxy_passwall2:
        description: "å¯ç”¨Passwall2"
        required: false
        default: false
        type: boolean
      proxy_luci_app_zzz:
        description: "å¯ç”¨luci-app-zzz"
        required: false
        default: false
        type: boolean
      proxy_luci_app_momo:
        description: "å¯ç”¨luci-app-momo"
        required: false
        default: false
        type: boolean
      threads:
        description: "ç¼–è¯‘çº¿ç¨‹æ•°ï¼ˆå¡«å†™ 0 åˆ™ä½¿ç”¨ nprocï¼‰"
        required: false
        default: "0"
        type: string
      cache_enabled:
        description: "å¯ç”¨ç¼“å­˜åŠ é€Ÿç¼–è¯‘"
        required: false
        default: true
        type: boolean
      enable_bbr:
        description: "å¯ç”¨ BBR æ‹¥å¡æ§åˆ¶"
        required: false
        default: true
        type: boolean
      custom_shell:
        description: "é»˜è®¤ shell"
        required: false
        default: "bash"
        type: choice
        options:
          - ash
          - bash
      luci_theme:
        description: "LuCI ä¸»é¢˜"
        required: false
        default: "argon"
        type: choice
        options:
          - argon
          - bootstrap
          - material
      custom_hostname:
        description: "è‡ªå®šä¹‰ hostnameï¼ˆç•™ç©ºåˆ™è·³è¿‡ï¼‰"
        required: false
        default: "Dwrt"
        type: string
      custom_ip:
        description: "è‡ªå®šä¹‰ IP åœ°å€ï¼ˆç•™ç©ºåˆ™è·³è¿‡ï¼‰"
        required: false
        default: "192.168.1.1"
        type: string
      root_password:
        description: "è‡ªå®šä¹‰ root å¯†ç ï¼ˆç•™ç©ºåˆ™è·³è¿‡ï¼‰"
        required: false
        default: ""
        type: string
      custom_banner:
        description: "è‡ªå®šä¹‰ SSH æ¨ªå¹…ï¼ˆç•™ç©ºåˆ™é»˜è®¤ï¼‰"
        required: false
        default: ""
        type: string

env:
  CCACHE_DIR: ${{ github.workspace }}/wrt/.ccache
  DL_DIR: ${{ github.workspace }}/wrt/dl

jobs:
  validate:
    name: éªŒè¯è¾“å…¥å‚æ•°
    runs-on: ubuntu-latest
    outputs:
      is_valid: ${{ steps.validate.outputs.is_valid }}
      config_exists: ${{ steps.validate.outputs.config_exists }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate inputs
        id: validate
        run: |
          echo "ğŸ” éªŒè¯è¾“å…¥å‚æ•°..."

          # éªŒè¯ threads å‚æ•°
          if [ -n "${{ inputs.threads }}" ]; then
            if ! [[ "${{ inputs.threads }}" =~ ^[0-9]+$ ]]; then
              echo "âŒ threads å‚æ•°å¿…é¡»æ˜¯æ•°å­—"
              echo "is_valid=false" >> "$GITHUB_OUTPUT"
              exit 1
            fi
          fi

          # éªŒè¯é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆå¦‚æœæä¾›äº†è·¯å¾„ï¼‰
          if [ -n "${{ inputs.config_path }}" ]; then
            if [ -f "${{ inputs.config_path }}" ]; then
              echo "config_exists=true" >> "$GITHUB_OUTPUT"
              echo "âœ… é…ç½®æ–‡ä»¶å­˜åœ¨ï¼š${{ inputs.config_path }}"
            else
              echo "config_exists=false" >> "$GITHUB_OUTPUT"
              echo "âš ï¸  é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼š${{ inputs.config_path }}ï¼Œå°†è·³è¿‡é…ç½®æ–‡ä»¶"
            fi
          else
            echo "config_exists=false" >> "$GITHUB_OUTPUT"
            echo "â„¹ï¸  æœªæä¾›é…ç½®æ–‡ä»¶è·¯å¾„ï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®"
          fi

          echo "is_valid=true" >> "$GITHUB_OUTPUT"
          echo "âœ… æ‰€æœ‰è¾“å…¥å‚æ•°éªŒè¯é€šè¿‡"

  build:
    name: ç¼–è¯‘å›ºä»¶
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 360

    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/{ghc,az,microsoft}
          sudo apt-get update && sudo apt-get install -y \
            build-essential clang flex bison g++ gawk gettext git \
            libncurses-dev libssl-dev python3{,-dev,-setuptools} \
            rsync unzip zlib1g-dev file wget curl \
            {gzip,tar,zip,xz-utils,bzip2,zstd} \
            make cmake {autoconf,automake,libtool,patch,diffutils} \
            findutils grep sed help2man texinfo \
            libelf-dev libfuse-dev liblzma-dev libxml2-dev libyaml-dev \
            uuid-dev device-tree-compiler antlr3 gperf \
            time bc jq xxd swig upx-ucl ccache ecj fastjar imagemagick \
            llvm linux-tools-common libbpf-dev linux-tools-$(uname -r) \
            u-boot-tools device-tree-compiler

      - name: Determine Git URL
        id: projectinfo
        run: |
          case "${{ inputs.project }}" in
            immortalwrt)       echo "url=https://github.com/immortalwrt/immortalwrt.git" >> $GITHUB_OUTPUT ;;
            immortalwrt-mt798x) echo "url=https://github.com/hanwckf/immortalwrt-mt798x.git" >> $GITHUB_OUTPUT ;;
            immortalwrt-mt798x-6.6) echo "url=https://github.com/padavanonly/immortalwrt-mt798x-6.6.git" >> $GITHUB_OUTPUT ;;
            openwrt)          echo "url=https://git.openwrt.org/openwrt/openwrt.git" >> $GITHUB_OUTPUT ;;
            *)                 echo "âŒ æœªçŸ¥é¡¹ç›®" >&2; exit 1 ;;
          esac

      - name: Clone Wrt source
        run: |
          echo "ğŸ“¥ å…‹éš† ${{ inputs.project }} (${{ inputs.version_type }})"

          [ "${{ inputs.version_type }}" = "snapshot" ] && BRANCH_MODE=1 || BRANCH_MODE=0

          if [ $BRANCH_MODE -eq 1 ]; then
            git clone --depth 1 "${{ steps.projectinfo.outputs.url }}" wrt
            cd wrt
            DEFAULT_BRANCH=$(git remote show origin | grep 'HEAD branch' | awk '{print $NF}')
            [ -z "$DEFAULT_BRANCH" ] && for b in main master openwrt-24.10; do
              git ls-remote --heads origin "$b" | grep -q "$b" && DEFAULT_BRANCH=$b && break
            done
            [ -z "$DEFAULT_BRANCH" ] && { echo "âŒ æ— æ³•ç¡®å®šé»˜è®¤åˆ†æ”¯"; exit 1; }
            git fetch origin "${DEFAULT_BRANCH}" 2>/dev/null
            git switch "${DEFAULT_BRANCH}" 2>/dev/null || git checkout "${DEFAULT_BRANCH}"
          else
            git clone "${{ steps.projectinfo.outputs.url }}" wrt
            cd wrt
            git checkout "${{ inputs.tag }}" 2>/dev/null || \
            (git fetch --tags && git checkout "${{ inputs.tag }}") || \
            { echo "âŒ æ ‡ç­¾ä¸å­˜åœ¨"; exit 1; }
          fi

          echo "ğŸ”– $(git describe --tags --always 2>/dev/null || git rev-parse --short HEAD)"
          echo "ğŸŒ¿ $(git branch --show-current 2>/dev/null || echo 'detached')"

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        if: inputs.cache_enabled == true
        with:
          key: ${{ runner.os }}-wrt-ccache-${{ inputs.project }}-${{ inputs.version_type }}
          max-size: 2G
          update-package-index: true

      - name: Cache downloads
        uses: actions/cache@v4
        if: inputs.cache_enabled == true
        with:
          path: wrt/dl
          key: ${{ runner.os }}-wrt-dl-${{ inputs.project }}-${{ inputs.version_type }}

      - name: Cache build directory
        uses: actions/cache@v4
        if: inputs.cache_enabled == true
        with:
          path: wrt/build_dir
          key: ${{ runner.os }}-wrt-build-${{ inputs.project }}-${{ inputs.version_type }}

      - name: Apply custom configurations
        working-directory: wrt
        run: |
          TARGET_TYPE=$(grep -qi immortalwrt package/base-files/files/etc/openwrt_release 2>/dev/null && echo ImmortalWrt || \
                       [ -d feeds/packages ] && echo ImmortalWrt || echo OpenWrt)
          CONFIG_GEN=package/base-files/files/bin/config_generate

          [ -n "${{ inputs.custom_hostname }}" ] && [ -f "$CONFIG_GEN" ] && \
            sed -i "s/${TARGET_TYPE}/${{ inputs.custom_hostname }}/g" "$CONFIG_GEN" && echo "âœ… Hostname: ${{ inputs.custom_hostname }}"

          [ -n "${{ inputs.custom_ip }}" ] && [ -f "$CONFIG_GEN" ] && \
            sed -i 's/192\.168\.[0-9]*\.[0-9]*/${{ inputs.custom_ip }}/g' "$CONFIG_GEN" && echo "âœ… IP: ${{ inputs.custom_ip }}"

          [ -n "${{ inputs.root_password }}" ] && [ -f package/base-files/files/etc/shadow ] && {
            HASH=$(openssl passwd -1 '${{ inputs.root_password }}')
            sed -i "s|^root:[^:]*:|root:${HASH}:|" package/base-files/files/etc/shadow
            echo "âœ… Root å¯†ç å·²è®¾ç½®"
          }

          mkdir -p package/base-files/files/etc/uci-defaults
          cat >package/base-files/files/etc/uci-defaults/99_set_theme <<'EOF'
          uci set luci.main.mediaurlbase=/luci-static/${{ inputs.luci_theme }}; uci commit luci
          EOF
          chmod +x package/base-files/files/etc/uci-defaults/99_set_theme

          if [ "${{ inputs.enable_bbr }}" = "true" ]; then
            mkdir -p package/base-files/files/etc/sysctl.d
            echo -e 'net.core.default_qdisc=fq_codel\nnet.ipv4.tcp_congestion_control=bbr' \
              > package/base-files/files/etc/sysctl.d/99-bbr.conf && echo "âœ… BBR å·²å¯ç”¨"
          else
            rm -f package/base-files/files/etc/sysctl.d/99-bbr.conf && echo "â„¹ï¸  BBR å·²ç¦ç”¨"
          fi

          PASSWD=package/base-files/files/etc/passwd
          if [ -f "$PASSWD" ]; then
            [ "${{ inputs.custom_shell }}" = "bash" ] && sed -i 's|/bin/ash|/bin/bash|g' "$PASSWD" || \
              sed -i 's|/bin/bash|/bin/ash|g' "$PASSWD"
            echo "âœ… Shell: ${{ inputs.custom_shell }}"
          fi

          mkdir -p package/base-files/files/etc
          if [ -n "${{ inputs.custom_banner }}" ]; then
            echo "${{ inputs.custom_banner }}" > package/base-files/files/etc/banner
          else
            cat >package/base-files/files/etc/banner <<'EOF'
          |   | _____   _____   ____________/  |______  |  |
          |   |/     \ /     \ /  _ \_  __ \   __\__  \ |  |
          |   |  Y Y  \  Y Y  (  <_> )  | \/|  |  / __ \|  |__
          |___|__|_|  /__|_|  /\____/|__|   |__| (____  /____/
                  \/      \/             By Dich    \/
          -----------------------------------------------------
          EOF
          fi && echo "âœ… Banner å·²è®¾ç½®"

      - name: Update and install feeds
        working-directory: wrt
        run: |
          if [ "${{ inputs.proxy_luci_app_zzz }}" = "true" ]; then
            echo "src-git luci-app-zzz https://github.com/Dichgrem/luci-app-zzz.git" >> feeds.conf.default
          fi
          if [ "${{ inputs.proxy_passwall2 }}" = "true" ]; then
            echo "src-git passwall https://github.com/xiaorouji/openwrt-passwall2.git" >> feeds.conf.default
          fi
          if [ "${{ inputs.proxy_luci_app_momo }}" = "true" ]; then
            echo "src-git momo https://github.com/nikkinikki-org/OpenWrt-momo.git" >> feeds.conf.default
          fi
          ./scripts/feeds update -a && ./scripts/feeds install -a


      - name: Setup configuration
        working-directory: wrt
        run: |
          # å¤åˆ¶é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœæä¾›ï¼‰
          if [ -n "${{ inputs.config_path }}" ] && [ -f "${{ inputs.config_path }}" ]; then
            echo "ğŸ“‹ å¤åˆ¶é…ç½®ï¼š${{ inputs.config_path }} â†’ .config"
            cp "${{ inputs.config_path }}" .config
          else
            echo "â„¹ï¸  æœªæä¾›é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
            # ç”Ÿæˆé»˜è®¤é…ç½®
            make defconfig || true
          fi

          # å¤‡ä»½é…ç½®æ–‡ä»¶ä»¥ä¾›å¯¹æ¯”
          cp .config .config.before_oldconfig

          echo "ğŸ”„ è¿è¡Œ defconfig"
          make defconfig

          echo "ğŸ”„ è¿è¡Œ oldconfig"
          make oldconfig

          echo "ğŸ” å¯¹æ¯” make oldconfig å‰åçš„ .config å·®å¼‚"
          if cmp -s .config.before_oldconfig .config; then
            echo "âœ… .config åœ¨ make oldconfig åæœªå‘ç”Ÿå˜åŒ–"
          else
            echo "âš ï¸ .config åœ¨ make oldconfig åå‘ç”Ÿå˜åŒ–ï¼Œå·®å¼‚å¦‚ä¸‹ï¼š"
            diff -u .config.before_oldconfig .config || true
          fi

      - name: Download packages
        working-directory: wrt
        run: |
          echo "â¬‡ï¸ ä¸‹è½½æ‰€æœ‰æºç åŒ…ï¼ˆä½¿ç”¨å•çº¿ç¨‹ -j1 é¿å…å¡ä½ï¼‰"
          set -o pipefail
          START=$(date +%s)
          time make download -j1
          END=$(date +%s)
          DURATION=$((END - START))
          echo "âœ… ä¸‹è½½å®Œæˆï¼Œè€—æ—¶ï¼š${DURATION}ç§’"

      - name: Build Firmware
        id: build
        working-directory: wrt
        run: |
          if [ "${{ inputs.threads }}" = "0" ] || [ -z "${{ inputs.threads }}" ]; then
            JOBS=$(nproc)
          else
            JOBS=${{ inputs.threads }}
          fi

          echo "ğŸš€ å…¨é‡ç¼–è¯‘ï¼ˆå¹¶è¡Œ ${JOBS}ï¼‰å¼€å§‹"
          START=$(date "+%Y-%m-%d %H:%M:%S")
          START_TS=$(date +%s)
          echo "â±ï¸ ç¼–è¯‘å¼€å§‹ï¼š${START}"
          echo "jobs_count=${JOBS}" >> "$GITHUB_OUTPUT"

          set -o pipefail

          # ç¬¬ä¸€æ¬¡å°è¯•å¤šçº¿ç¨‹ç¼–è¯‘ï¼Œå¹¶ä¿å­˜æ—¥å¿—
          if ! (time make world -j${JOBS} 2>&1 | tee world_debug.log); then
            echo "âš ï¸ å¤šçº¿ç¨‹ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨å•çº¿ç¨‹å¹¶è¾“å‡ºè¯¦ç»†ä¿¡æ¯..."

            # å•çº¿ç¨‹æ¨¡å¼è¾“å‡ºè¯¦ç»†ä¿¡æ¯ï¼Œå¹¶è¿½åŠ åˆ°åŒä¸€æ—¥å¿—
            time make world -j1 V=s 2>&1 | tee -a world_debug.log

            echo "âŒ å•çº¿ç¨‹ç¼–è¯‘åä¾ç„¶å¤±è´¥ï¼Œä»¥ä¸‹æ˜¯åŒ¹é…å…³é”®å­—çš„é”™è¯¯è¡Œï¼š"
            grep -E -i "(error:|failed|fatal|cannot install package)" -n world_debug.log || true

            exit 1
          fi

          END=$(date "+%Y-%m-%d %H:%M:%S")
          END_TS=$(date +%s)
          DURATION=$((END_TS - START_TS))
          DURATION_H=$((DURATION / 3600))
          DURATION_M=$(((DURATION % 3600) / 60))
          DURATION_S=$((DURATION % 60))
          
          echo "âœ… ç¼–è¯‘æˆåŠŸ"
          echo "â±ï¸ ç¼–è¯‘ç»“æŸï¼š${END}"
          echo "â±ï¸ æ€»è€—æ—¶ï¼š${DURATION_H}å°æ—¶ ${DURATION_M}åˆ†é’Ÿ ${DURATION_S}ç§’"
          echo "build_success=true" >> "$GITHUB_OUTPUT"

      - name: Build statistics
        if: steps.build.outputs.build_success == 'true'
        working-directory: wrt
        run: |
          echo "ğŸ“Š ç¼–è¯‘ç»Ÿè®¡ä¿¡æ¯ï¼š"
          echo "é¡¹ç›®ï¼š${{ inputs.project }}"
          echo "ç‰ˆæœ¬ç±»å‹ï¼š${{ inputs.version_type }}"

          if [ "${{ inputs.version_type }}" = "snapshot" ]; then
            VERSION_INFO=$(git describe --tags --always 2>/dev/null || echo "latest")
            BRANCH_INFO=$(git branch --show-current 2>/dev/null || echo "unknown")
            echo "ç‰ˆæœ¬ï¼š${VERSION_INFO} (${BRANCH_INFO}åˆ†æ”¯)"
          else
            echo "ç‰ˆæœ¬ï¼š${{ inputs.tag }} (ç¨³å®šç‰ˆ)"
          fi

          echo "ç¼–è¯‘çº¿ç¨‹ï¼š${{ steps.build.outputs.jobs_count }}"
          echo "ç¼“å­˜çŠ¶æ€ï¼š${{ inputs.cache_enabled }}"
          echo ""
          echo "å›ºä»¶æ–‡ä»¶åˆ—è¡¨ï¼š"
          if [ -d bin/targets ]; then
            find bin/targets -type f -exec ls -lh {} \; | awk '{print $9, $5}'
            echo ""
            echo "æ€»å›ºä»¶å¤§å°ï¼š"
            du -sh bin/targets
          fi

      - name: Upload build log on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: ${{ inputs.project }}-build-log-error
          path: wrt/world_debug.log
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: steps.build.outputs.build_success == 'true'
        with:
          name: ${{ inputs.project }}-output-${{ inputs.version_type }}-${{ github.run_number }}
          path: |
            wrt/bin/targets/**
            !wrt/bin/targets/x86/64/packages/**
            !wrt/bin/targets/**/packages/**
          if-no-files-found: warn
          compression-level: 6
          overwrite: false
          retention-days: 30

      - name: Upload config diff
        uses: actions/upload-artifact@v4
        if: steps.build.outputs.build_success == 'true'
        with:
          name: ${{ inputs.project }}-config-diff
          path: |
            wrt/.config
            wrt/.config.before_oldconfig
          if-no-files-found: ignore
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç†å·¥ä½œç©ºé—´..."
          if [ -d "wrt" ]; then
            cd wrt
            make clean || true
            echo "âœ… æ¸…ç†å®Œæˆ"
          else
            echo "â„¹ï¸  wrt ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡æ¸…ç†"
          fi
