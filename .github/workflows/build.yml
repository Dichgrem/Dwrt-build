name: Build Custom WRT

on:
  workflow_dispatch:
    inputs:
      project:
        description: "é€‰æ‹© WRT é¡¹ç›®"
        required: true
        default: "immortalwrt"
        type: choice
        options:
          - openwrt
          - immortalwrt
          - x-wrt
          - lienol
          - lede
      version_type:
        description: "ç‰ˆæœ¬ç±»å‹"
        required: true
        default: "stable"
        type: choice
        options:
          - "snapshot"
          - "stable"
      branch:
        description: "snapshot-branch"
        required: false
        default: "master"
        type: string
      tag:
        description: "stable-tag"
        required: false
        default: "v24.10.2"
        type: string
      config_path:
        description: "config è·¯å¾„"
        required: true
        default: "config/myconfig"
        type: string
      threads:
        description: "ç¼–è¯‘çº¿ç¨‹æ•°ï¼ˆç•™ç©ºæˆ–å¡«å†™ 0 åˆ™è‡ªåŠ¨ä½¿ç”¨ nprocï¼‰"
        required: false
        default: "0"
        type: string

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          echo "ğŸ§¹ å¼€å§‹æ¸…ç†æ— ç”¨æ–‡ä»¶ï¼Œé‡Šæ”¾ç£ç›˜ç©ºé—´"
          # åˆ é™¤é¢„è£…ä½†ç¼–è¯‘ä¸­ä¸éœ€è¦çš„ SDK/å·¥å…·
          sudo rm -rf /usr/share/dotnet \
                      /usr/local/lib/android \
                      /opt/ghc \
                      /opt/hostedtoolcache \
                      /opt/az \
                      /opt/microsoft
          # åˆ é™¤ GitHub Actions self-hosted runner ç¼“å­˜ç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          # åˆ é™¤ç³»ç»Ÿç¼“å­˜å’Œæ—¥å¿—
          sudo rm -rf /var/cache/apt/archives/* /var/lib/apt/lists/* /var/log/*.log
          # æ˜¾ç¤ºå½“å‰ç£ç›˜ä½¿ç”¨æƒ…å†µ
          echo "ğŸ“Š ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
          df -h || true

      - name: Determine Git ref
        id: refinfo
        run: |
          if [ "${{ inputs.version_type }}" = "snapshot" ]; then
            echo "ref=${{ inputs.branch }}" >> $GITHUB_OUTPUT
          else
            echo "ref=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk gettext git \
            libncurses-dev libssl-dev python3 python3-dev python3-setuptools \
            rsync unzip zlib1g-dev file wget curl \
            gzip tar zip xz-utils bzip2 zstd \
            make cmake autoconf automake libtool patch diffutils \
            findutils grep sed help2man texinfo \
            libelf-dev libfuse-dev liblzma-dev libxml2-dev libyaml-dev \
            uuid-dev device-tree-compiler antlr3 gperf \
            time bc jq xxd swig upx-ucl ccache ecj fastjar imagemagick \
            llvm linux-tools-common libbpf-dev linux-tools-$(uname -r)

      - name: Determine Git URL
        id: projectinfo
        run: |
          case "${{ inputs.project }}" in
            immortalwrt)
              echo "url=https://github.com/immortalwrt/immortalwrt.git" >> $GITHUB_OUTPUT
              ;;
            x-wrt)
              echo "url=https://github.com/x-wrt/x-wrt.git" >> $GITHUB_OUTPUT
              ;;
            openwrt)
              echo "url=https://git.openwrt.org/openwrt/openwrt.git" >> $GITHUB_OUTPUT
              ;;
            lienol)
              echo "url=https://github.com/Lienol/openwrt.git" >> $GITHUB_OUTPUT
              ;;
            lede)
              echo "url=https://github.com/coolsnowwolf/lede.git" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "âŒ æœªçŸ¥é¡¹ç›®: ${{ inputs.project }}" >&2
              exit 1
              ;;
          esac

      - name: Clone repository
        run: |
          echo "ğŸ“¥ å…‹éš† ${{ inputs.project }} ä»“åº“"
          git clone "${{ steps.projectinfo.outputs.url }}" wrt
          cd wrt
          echo "ğŸ”– åˆ‡æ¢åˆ°ç‰ˆæœ¬ï¼š${{ steps.refinfo.outputs.ref }}"
          git checkout "${{ steps.refinfo.outputs.ref }}"

      - name: Copy and Run diy.sh
        run: |
          echo "ğŸ“‚ å¤åˆ¶ diy.sh åˆ° wrt ç›®å½•å¹¶æ‰§è¡Œ"
          cp diy.sh wrt/diy.sh
          cd wrt
          chmod +x diy.sh
          ./diy.sh

      - name: Update and install feeds
        working-directory: wrt
        run: |
          echo "ğŸ“¦ æ›´æ–° feeds"
          ./scripts/feeds update -a
          echo "ğŸ“¦ å®‰è£… feeds"
          ./scripts/feeds install -a

      - name: Setup configuration
        run: |
          echo "ğŸ“‹ å¤åˆ¶é…ç½®ï¼š${{ inputs.config_path }} â†’ wrt/.config"
          if [ ! -f "${{ inputs.config_path }}" ]; then
            echo "âŒ æ‰¾ä¸åˆ°é…ç½®æ–‡ä»¶ï¼š${{ inputs.config_path }}"
            exit 1
          fi

          cp "${{ inputs.config_path }}" wrt/.config

          cd wrt

          echo "ğŸ“‘ å¤‡ä»½é…ç½®æ–‡ä»¶ä»¥ä¾›å¯¹æ¯”"
          cp .config .config.before_oldconfig

          echo "ğŸ”„ è¿è¡Œ make oldconfig"
          make oldconfig

          echo "ğŸ” å¯¹æ¯” make oldconfig å‰åçš„ .config å·®å¼‚"
          if cmp -s .config.before_oldconfig .config; then
            echo "âœ… .config åœ¨ make oldconfig åæœªå‘ç”Ÿå˜åŒ–"
          else
            echo "âš ï¸ .config åœ¨ make oldconfig åå‘ç”Ÿå˜åŒ–ï¼Œå·®å¼‚å¦‚ä¸‹ï¼š"
            diff -u .config.before_oldconfig .config || true
          fi

      - name: Download source packages
        working-directory: wrt
        run: |
          echo "â¬‡ï¸ ä¸‹è½½æ‰€æœ‰æºç åŒ…ï¼ˆä½¿ç”¨å•çº¿ç¨‹ -j1 é¿å…å¡ä½ï¼‰"
          set -o pipefail
          time make download -j1

      - name: Build Firmware
        working-directory: wrt
        run: |
          if [ "${{ inputs.threads }}" = "0" ] || [ -z "${{ inputs.threads }}" ]; then
            JOBS=$(nproc)
          else
            JOBS=${{ inputs.threads }}
          fi

          echo "ğŸš€ å…¨é‡ç¼–è¯‘ï¼ˆå¹¶è¡Œ ${JOBS}ï¼‰å¼€å§‹"
          START=$(date "+%Y-%m-%d %H:%M:%S")
          echo "â±ï¸ ç¼–è¯‘å¼€å§‹ï¼š${START}"

          set -o pipefail

          # ç¬¬ä¸€æ¬¡å°è¯•å¤šçº¿ç¨‹ç¼–è¯‘ï¼Œå¹¶ä¿å­˜æ—¥å¿—
          if ! (time make world -j${JOBS} 2>&1 | tee world_debug.log); then
            echo "âš ï¸ å¤šçº¿ç¨‹ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨å•çº¿ç¨‹å¹¶è¾“å‡ºè¯¦ç»†ä¿¡æ¯..."

            # å•çº¿ç¨‹æ¨¡å¼è¾“å‡ºè¯¦ç»†ä¿¡æ¯ï¼Œå¹¶è¿½åŠ åˆ°åŒä¸€æ—¥å¿—
            time make world -j1 V=s 2>&1 | tee -a world_debug.log

            echo "âŒ å•çº¿ç¨‹ç¼–è¯‘åä¾ç„¶å¤±è´¥ï¼Œä»¥ä¸‹æ˜¯åŒ¹é…å…³é”®å­—çš„é”™è¯¯è¡Œï¼š"
            grep -E -i "(error:|failed|fatal|cannot install package)" -n world_debug.log || true

            exit 1
          fi

          END=$(date "+%Y-%m-%d %H:%M:%S")
          echo "âœ… ç¼–è¯‘æˆåŠŸ"
          echo "â±ï¸ ç¼–è¯‘ç»“æŸï¼š${END}"

      - name: list all target files
        run: |
          echo ">>> æ‰“å° wrt/bin/targets ä¸‹æ‰€æœ‰æ–‡ä»¶ï¼š"
          if [ -d wrt/bin/targets ]; then
            find wrt/bin/targets -type f | sed 's/^/  - /'
          else
            echo "â— wrt/bin/targets ç›®å½•ä¸å­˜åœ¨"
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.project }}-output
          path: |
            wrt/bin/targets/**
            !wrt/bin/targets/x86/64/packages/**
          if-no-files-found: warn
          compression-level: 6
          overwrite: false

      - name: Upload build log
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.project }}-build-log
          path: wrt/world_debug.log
